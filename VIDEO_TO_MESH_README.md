# Video to 3D Mesh Pipeline - README

## Overview
This script converts drone video files into 3D meshes using a photogrammetry pipeline. It combines OpenCV for frame extraction, COLMAP for 3D reconstruction, and Open3D for mesh generation and post-processing.

## Features
- **Automated Frame Extraction**: Extracts frames at 2 FPS using OpenCV
- **COLMAP Integration**: Complete photogrammetry workflow (feature extraction, matching, sparse/dense reconstruction)
- **Mesh Generation**: Point cloud cleaning and Poisson surface reconstruction with Open3D
- **Error Handling**: Comprehensive try-except blocks and logging
- **Modular Design**: Separate functions for each pipeline stage

## Prerequisites

### 1. Install Python Dependencies
```bash
pip install -r requirements.txt
```

This will install:
- `opencv-python` - Frame extraction and video processing
- `open3d` - 3D point cloud processing and mesh generation
- `numpy` - Numerical operations

### 2. Install COLMAP

**COLMAP is required and must be installed separately.**

#### Windows:
1. Download from [COLMAP Releases](https://github.com/colmap/colmap/releases)
2. Extract to a folder (e.g., `C:\Program Files\COLMAP`)
3. Add COLMAP to your system PATH:
   - Open System Properties → Environment Variables
   - Edit the `Path` variable
   - Add the path to COLMAP's bin folder

#### Linux:
```bash
sudo apt-get install colmap
```

Or build from source following [COLMAP documentation](https://colmap.github.io/install.html)

#### Verify Installation:
```bash
colmap -h
```

## Usage

### Basic Usage
1. Place your drone video as `input_video.mp4` in the same directory as the script
2. Run the script:
```bash
python video_to_mesh_pipeline.py
```

3. The output mesh will be saved as `output/output_mesh.ply`

### Custom Configuration
Edit the `main()` function to customize:
```python
INPUT_VIDEO = "your_video.mp4"        # Input video path
OUTPUT_DIR = "./custom_output"         # Output directory
OUTPUT_MESH = "custom_mesh.ply"        # Output mesh name
FRAMES_PER_SECOND = 2                  # Frame extraction rate
```

Or use the class directly:
```python
from video_to_mesh_pipeline import VideoTo3DMesh

pipeline = VideoTo3DMesh(
    video_path="drone_footage.mp4",
    output_dir="./my_reconstruction",
    frames_per_second=3
)

mesh_path = pipeline.run_full_pipeline(output_mesh_name="my_mesh.ply")
```

## Pipeline Stages

### 1. Frame Extraction (OpenCV)
Extracts frames from video at specified FPS rate and saves as JPEG images.

### 2. Feature Extraction (COLMAP)
Detects and describes SIFT features in each frame.

### 3. Feature Matching (COLMAP)
Matches features across all image pairs using exhaustive matching.

### 4. Sparse Reconstruction (COLMAP)
Builds a sparse 3D point cloud and estimates camera positions.

### 5. Image Undistortion (COLMAP)
Removes lens distortion from images for dense reconstruction.

### 6. Dense Reconstruction (COLMAP)
Computes depth maps using patch match stereo.

### 7. Stereo Fusion (COLMAP)
Fuses depth maps into a dense 3D point cloud (fused.ply).

### 8. Post-Processing (Open3D)
- Removes statistical outliers (noise reduction)
- Estimates and orients surface normals
- Performs Poisson surface reconstruction
- Cleans low-density regions
- Saves final mesh

## Output Structure
```
output/
├── images/                  # Extracted frames
│   ├── frame_000000.jpg
│   ├── frame_000001.jpg
│   └── ...
├── colmap/
│   ├── database.db         # COLMAP feature database
│   ├── sparse/             # Sparse reconstruction
│   │   └── 0/
│   └── dense/              # Dense reconstruction
│       ├── fused.ply       # Dense point cloud
│       ├── images/         # Undistorted images
│       └── stereo/         # Depth maps
└── output_mesh.ply         # Final 3D mesh
```

## Troubleshooting

### "COLMAP not found"
- Verify COLMAP is installed: `colmap -h`
- Check that COLMAP is in your system PATH
- On Windows, restart your terminal after adding to PATH

### "Not enough frames extracted"
- Check that your input video exists and is readable
- Verify video file is not corrupted
- Try increasing `frames_per_second` parameter

### COLMAP reconstruction fails
- Ensure frames have sufficient overlap and texture
- Video should be captured with smooth motion
- Avoid motion blur and ensure good lighting
- Try with higher quality input video

### Open3D post-processing issues
- Check that `fused.ply` was generated by COLMAP
- Verify point cloud has sufficient points (>1000)
- Adjust outlier removal parameters if mesh quality is poor

## Performance Notes
- Processing time depends on video length and quality
- Typical 30-second drone video: 10-30 minutes on mid-range GPU
- GPU acceleration recommended for COLMAP (enabled by default)
- Dense reconstruction is the most time-consuming stage

## Tips for Best Results
1. **Video Quality**: Use high-resolution, stable footage
2. **Camera Movement**: Smooth, overlapping coverage (70-80% overlap)
3. **Lighting**: Consistent lighting, avoid shadows/glare
4. **Frame Rate**: 2 FPS works for most cases; increase for fast motion
5. **Subject**: Textured surfaces work best; avoid reflective/transparent objects

## License
This script is provided as-is for educational and commercial use.

## Author
Senior Computer Vision Engineer
Date: 2025-12-05
